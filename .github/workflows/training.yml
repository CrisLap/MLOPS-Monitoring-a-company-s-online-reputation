name: Training Pipeline

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]

  workflow_dispatch:
    inputs:
      epoch:
        description: "Number of training epochs"
        default: "5"
      lr:
        description: "Learning rate for training"
        default: "0.1"

  schedule:
    - cron: "0 2 * * 4"
permissions:
  contents: read
  packages: read
env:
  REGISTRY: ghcr.io
  ORG: crislap
  PROJECT: mlops-monitoring-a-company-s-online-reputation
  IMAGE_TRAINING: training

jobs:
  train:
    name: Train Model
    runs-on: ubuntu-latest

    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull training image
        run: |
          docker pull $REGISTRY/$ORG/$PROJECT/$IMAGE_TRAINING:latest

      - name: Run training inside container
        run: |
          mkdir -p container_artifacts

          docker run --rm \
            -e EPOCH=${{ github.event.inputs.epoch || '5' }} \
            -e LR=${{ github.event.inputs.lr || '0.1' }} \
            -v $PWD/container_artifacts:/artifacts \
            $REGISTRY/$ORG/$PROJECT/$IMAGE_TRAINING:latest \
            python -m training.train --output /artifacts

      - name: Validate model
        run: |
          test -f container_artifacts/sentiment_ft.bin

      - name: Save metadata (CI)
        run: |
          mkdir -p ci_artifacts

          cat > ci_artifacts/metadata.json <<EOF
          {
            "git_sha": "$GITHUB_SHA",
            "epoch": "$EPOCH",
            "lr": "$LR",
            "trained_at": "$TRAINED_AT"
          }
          EOF

      - name: Upload model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: container_artifacts/

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: training-metadata
          path: ci_artifacts/metadata.json



