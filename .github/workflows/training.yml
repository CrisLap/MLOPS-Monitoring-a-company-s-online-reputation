name: Training Pipeline

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      epoch:
        description: 'Number of training epochs'
        required: false
        default: '5'
        type: string
      lr:
        description: 'Learning rate'
        required: false
        default: '0.1'
        type: string
  schedule:
    - cron: '0 2 * * 4'  # Weekly on Thursdays at 2 AM UTC

env:
  PYTHON_VERSION: "3.10"
  REGISTRY: ghcr.io
  IMAGE_NAME_TRAINING: mlops-monitoring-a-company-s-online-reputation/training

jobs:
  train-model:
    name: Train Sentiment Model
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install mlflow

      - name: Start MLflow server
        run: |
          mkdir -p /tmp/mlflow
          mlflow server --host 0.0.0.0 --port 5000 \
            --backend-store-uri sqlite:////tmp/mlflow/mlflow.db \
            --default-artifact-root /tmp/mlflow/artifacts &
          sleep 15

      - name: Wait for MLflow to be ready
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:5000 || curl -f http://localhost:5000/health; do sleep 2; done'

      - name: Clean temp folders
        run: |
          rm -rf /tmp/my-app-* /tmp/mlflow /tmp/pip-cache || true
          df -h

      - name: Run training
        env:
          MLFLOW_TRACKING_URI: http://localhost:5000
          PYTHONPATH: ${{ github.workspace }}
          EPOCH: ${{ github.event.inputs.epoch || '5' }}
          LR: ${{ github.event.inputs.lr || '0.1' }}
        run: |
          python -c "
          import training.train as train_module
          epoch = int('$EPOCH')
          lr = float('$LR')
          model_path = train_module.train(epoch=epoch, lr=lr)
          print(f'Training completed. Model saved to: {model_path}')
          "

      - name: Validate model artifact
        run: |
          if [ -f "models/sentiment_ft.bin" ]; then
            echo "Model artifact created successfully"
            ls -lh models/sentiment_ft.bin
          else
            echo "Warning: Model artifact not found"
            exit 1
          fi

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/sentiment_ft.bin
          retention-days: 10

      - name: Clean temp folders
        run: |
          rm -rf /tmp/my-app-* /tmp/mlflow /tmp/pip-cache || true
          df -h

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
      
      - name: Set lowercase repo owner
        run: |
          echo "REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push training image (CPU)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.training
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_TRAINING }}:latest
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_TRAINING }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Clean temp folders
        run: |
          rm -rf /tmp/my-app-* /tmp/mlflow /tmp/pip-cache || true
          df -h

      # Optional: GPU variant
      - name: Build and push training image (GPU)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.training
          push: true
          build-args: BASE_IMAGE=nvidia/cuda:12.1.1-devel-ubuntu22.04
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_TRAINING }}:gpu-latest
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME_TRAINING }}:gpu-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Cleanup MLflow temporary files
        run: |
          rm -rf /tmp/mlflow


