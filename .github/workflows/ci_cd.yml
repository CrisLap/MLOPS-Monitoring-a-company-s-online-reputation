name: CI-CD

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '37 3 * * 6' #weekly

env:
  IMAGE_API: online-reputation-api
  IMAGE_TRAINING: sentiment-training
  HF_MODEL_REPO: CrisLap/sentiment-model
  HF_SPACE_REPO: CrisLap/online-reputation-api
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install -r requirements.txt -r requirements-dev.txt
      - run: python -m compileall .

  lint-test:
    runs-on: ubuntu-latest
    needs: validate
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install -r requirements.txt -r requirements-dev.txt
      - run: black --check --diff .
      - run: flake8 .
      - run: python -m pytest -v

  build:
    runs-on: ubuntu-latest
    needs: lint-test
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t $IMAGE_API .
      - run: docker build -f Dockerfile.training -t $IMAGE_TRAINING .

  train-and-push-model:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: pip install -r requirements.txt huggingface_hub
      
      - name: Run Data Drift Check
        run: python drift_check.py

      - name: Train FastText model
        # The script generates metrics.json and the model .ftz in the models/ folder
        run: python -m training.train --epoch 5

      - name: Conditional Model Push
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_MODEL_REPO: ${{ env.HF_MODEL_REPO }}
          # Recommended threshold for a 3-class sentiment classifier
          MIN_F1_THRESHOLD: 0.60
        run: |
          python - <<EOF
          import json
          import os
          from pathlib import Path
          from huggingface_hub import HfApi

          # 1. Load the metrics generated by train.py
          metrics_path = Path("models/metrics.json")
          
          if not metrics_path.exists():
              print("Critical Error: metrics.json not found in models/ directory.")
              exit(1)

          with open(metrics_path, "r") as f:
              metrics = json.load(f)

          f1_score = metrics.get("f1_score", 0)
          threshold = float(os.getenv("MIN_F1_THRESHOLD", 0.60))

          print(f"Current Model F1 Score: {f1_score}")
          print(f"Required Minimum Threshold: {threshold}")

          # 2. Evaluation Logic
          if f1_score >= threshold:
              print("Performance threshold met. Proceeding with Hugging Face upload...")
              
              try:
                  api = HfApi(token=os.getenv("HF_TOKEN"))
                  commit_sha = os.getenv("GITHUB_SHA")
                  api.upload_file(
                      path_or_fileobj="models/sentiment_ft.ftz",
                      path_in_repo="sentiment_ft.ftz",
                      repo_id=os.getenv("HF_MODEL_REPO"),
                      repo_type="model",
                      commit_message=f"Model trained from commit {commit_sha}",
                      commit_description=f"F1 Score: {f1_score}"
                  )
                  api.create_tag(repo_id=os.getenv("HF_MODEL_REPO"), tag=f"v-{commit_sha[:7]}", repo_type="model")
                  print("Model successfully uploaded to Hugging Face Hub and versioned..")
              except Exception as e:
                  print(f"Upload failed: {e}")
                  exit(1)
          else:
              # Log the skip and prevent the upload
              print(f"Model F1 Score ({f1_score}) is below threshold ({threshold}).")
              print("Push skipped to prevent deploying a sub-optimal model.")
              # Note: Use exit 1 here if you want the GitHub Action to mark the job as 'failed'
          EOF

  deploy-space:
    runs-on: ubuntu-latest
    needs: train-and-push-model
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check and Create Space if missing
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Check if the Space exists (returns 200 if it exists, 404 if it is missing)
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://huggingface.co/api/spaces/${{ env.HF_SPACE_REPO }})
          
          if [ "$STATUS" -eq 404 ]; then
            echo "Space does not exist. Creation in progress..."
            curl -X POST https://huggingface.co/api/repos/create \
              -H "Authorization: Bearer $HF_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "'"${{ env.HF_SPACE_REPO }}"'",
                "type": "space",
                "sdk": "docker",
                "private": false
              }'
          else
            echo "Space already exists. I will proceed with updating the code.."
          fi

      - name: Push to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "CI Bot"
          # We perform the push: if the Space has just been created or already exists, the code will be aligned.
          git push --force https://token:${HF_TOKEN}@huggingface.co/spaces/${{ env.HF_SPACE_REPO }} main

  integration-test:
    runs-on: ubuntu-latest
    needs: deploy-space
    steps:
      - name: Wait for Space to be ready
        run: sleep 60 # Allow time for the container to start up (adjustable)

      - name: Health Check & Prediction Test
        run: |
          # Let's build the Space URL
          # Note: Hugging Face transforms the space name into a URL: user-repo.hf.space
          SPACE_URL="https://crislap-online-reputation-api.hf.space/predict"
          
          echo "Testing Space at $SPACE_URL"
          
          # API call attempt
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "$SPACE_URL" \
            -H "Content-Type: application/json" \
            -d '{"text": "This product is fantastic!"}')
          
          HTTP_CODE=${RESPONSE: -3}
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Integration Test Passed: API is responding correctly."
          else
            echo "Integration Test Failed with status: $HTTP_CODE"
            exit 1
          fi





