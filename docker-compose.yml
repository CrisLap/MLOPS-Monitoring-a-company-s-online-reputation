version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile  # Use the main Dockerfile for the FastAPI service
    container_name: sentiment_api
    ports:
      - "7860:7860"  # Expose FastAPI on port 7860
    environment:
      HF_MODEL_REPO: "CrisLap/sentiment-model"  # Hugging Face model repository
      HF_TOKEN: "${HF_TOKEN}"  # Hugging Face token from local environment
      MLFLOW_TRACKING_URI: "http://mlflow:5000"  # Optional: MLflow tracking server
    depends_on:
      - training  # Optional: start training container first
    volumes:
      - ./app:/app  # Mount local app code for development
      - ./models:/app/models  # Share model folder with container

  training:
    build:
      context: .
      dockerfile: Dockerfile.training  # Use Dockerfile for training
    container_name: sentiment_training
    environment:
      HF_MODEL_REPO: "CrisLap/sentiment-model"
      HF_TOKEN: "${HF_TOKEN}"
      MLFLOW_TRACKING_URI: "http://mlflow:5000"
    volumes:
      - ./training:/train/training  # Mount local training scripts
      - ./models:/train/models  # Persist trained models to host
    # CMD is already defined in Dockerfile.training

